<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard HR - Analisi Turni 2025</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #666;
            font-size: 14px;
        }
        
        .guarantee-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 5px;
        }
        
        .guarantee-box strong {
            color: #155724;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }
        
        .tab-button:hover {
            color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .metric-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .metric-card .value {
            font-size: 32px;
            font-weight: bold;
        }
        
        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .controls label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .controls select, .controls input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .controls select:focus, .controls input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .comparison-row {
            display: grid;
            grid-template-columns: 2fr 1fr 2fr 1fr 1fr 1fr;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }
        
        .comparison-row:hover {
            background: #f8f9fa;
        }
        
        .comparison-row.header {
            font-weight: bold;
            background: #667eea;
            color: white;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }
        
        .status-equo {
            background: #d4edda;
            color: #155724;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Dashboard HR - Analisi Turni 2025</h1>
            <p class="subtitle">‚öñÔ∏è Analisi Equit√† e Compliance - Calcoli Python Certificati</p>
        </div>
        
        <div class="guarantee-box">
            üîí <strong>GARANZIA</strong>: Tutti i calcoli sono eseguiti da JavaScript/Python (matematica pura). 
            Zero AI nei numeri. Risultati deterministici e verificabili.
        </div>
        
        <div class="alert alert-info" id="loadingAlert">
            üìÇ Caricamento dati in corso...
        </div>
        
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('overview')">üìä Overview</button>
            <button class="tab-button" onclick="showTab('confronti')">üîç Confronti</button>
            <button class="tab-button" onclick="showTab('grafici')">üìà Grafici</button>
            <button class="tab-button" onclick="showTab('equita')">‚öñÔ∏è Indici Equit√†</button>
            <button class="tab-button" onclick="showTab('dettaglio')">üìã Dettaglio</button>
        </div>
        
        <!-- TAB OVERVIEW -->
        <div id="overview" class="tab-content active">
            <h2>üìä Overview Generale</h2>
            
            <div class="metrics-grid" id="metricsGrid">
                <!-- Popolato da JavaScript -->
            </div>
            
            <h3>üìã Metriche per Staff</h3>
            <div id="staffTable"></div>
        </div>
        
        <!-- TAB CONFRONTI -->
        <div id="confronti" class="tab-content">
            <h2>üîç Confronto Tra Staff</h2>
            
            <div class="controls">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label>Staff 1:</label>
                        <select id="staff1Select" onchange="updateComparison()">
                            <!-- Popolato da JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label>Staff 2:</label>
                        <select id="staff2Select" onchange="updateComparison()">
                            <!-- Popolato da JavaScript -->
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="comparisonResult"></div>
        </div>
        
        <!-- TAB GRAFICI -->
        <div id="grafici" class="tab-content">
            <h2>üìà Visualizzazioni</h2>
            
            <div class="chart-container">
                <canvas id="oreChart"></canvas>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="chart-container">
                    <canvas id="turniChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="riposiChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- TAB EQUIT√Ä -->
        <div id="equita" class="tab-content">
            <h2>‚öñÔ∏è Indici di Equit√†</h2>
            
            <div class="guarantee-box">
                üìê <strong>Formula CV</strong>: (Deviazione Standard / Media) √ó 100<br>
                üî¢ <strong>Calcolo</strong>: Math.sqrt(variance) / mean - Matematica JavaScript pura
            </div>
            
            <div id="cvTable"></div>
            
            <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 5px;">
                <strong>üìñ Interpretazione CV:</strong><br>
                ‚Ä¢ <strong>&lt; 10%</strong>: Distribuzione equa ‚úÖ<br>
                ‚Ä¢ <strong>10-20%</strong>: Accettabile ma da monitorare ‚ö†Ô∏è<br>
                ‚Ä¢ <strong>&gt; 20%</strong>: Squilibrio significativo ‚ùå
            </div>
        </div>
        
        <!-- TAB DETTAGLIO -->
        <div id="dettaglio" class="tab-content">
            <h2>üìã Dati Dettagliati</h2>
            
            <div class="controls">
                <label>Filtra per Staff:</label>
                <select id="filterStaff" onchange="updateDetailTable()">
                    <option value="">Tutti</option>
                    <!-- Popolato da JavaScript -->
                </select>
            </div>
            
            <div id="detailTable" style="overflow-x: auto;"></div>
            
            <button onclick="downloadCSV()" style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                üì• Scarica Dati Filtrati (CSV)
            </button>
        </div>
    </div>
    
    <script>
        let data = [];
        let staffList = [];
        
        // Carica dati dal CSV
        async function loadData() {
            try {
                const response = await fetch('turni_completi_52_settimane.csv');
                const csv = await response.text();
                
                Papa.parse(csv, {
                    header: true,
                    dynamicTyping: true,
                    complete: function(results) {
                        data = results.data.filter(row => row.staff);
                        staffList = [...new Set(data.map(r => r.staff))].sort();
                        
                        document.getElementById('loadingAlert').innerHTML = 
                            `‚úÖ Dati caricati: <strong>${data.length} turni</strong> da <strong>${staffList.length} staff</strong>`;
                        document.getElementById('loadingAlert').className = 'alert alert-info';
                        
                        initializeDashboard();
                    }
                });
            } catch (error) {
                document.getElementById('loadingAlert').innerHTML = 
                    '‚ùå Errore nel caricamento dati. Assicurati che turni_completi_52_settimane.csv sia nella stessa cartella.';
                document.getElementById('loadingAlert').style.background = '#f8d7da';
            }
        }
        
        // Calcola metriche per staff (MATEMATICA PURA JAVASCRIPT)
        function calcMetriche(staffName) {
            const staffData = data.filter(r => r.staff === staffName);
            
            const turniNormali = staffData.filter(r => r.tipo_turno === 'NORMALE').length;
            const riposi = staffData.filter(r => ['RIPO', 'RDOM'].includes(r.tipo_turno)).length;
            const ferie = staffData.filter(r => r.tipo_turno === 'FERIOR').length;
            const off = staffData.filter(r => ['OFF', 'CHIUSO'].includes(r.tipo_turno)).length;
            
            const oreData = staffData.filter(r => r.ore_lavoro && !isNaN(r.ore_lavoro));
            const oreTotali = oreData.reduce((sum, r) => sum + parseFloat(r.ore_lavoro), 0);
            const oreMedia = oreData.length > 0 ? oreTotali / oreData.length : 0;
            
            return {
                'Turni Totali': staffData.length,
                'Turni Normali': turniNormali,
                'Riposi': riposi,
                'Ferie': ferie,
                'OFF/Chiuso': off,
                'Ore Totali': oreTotali.toFixed(1),
                'Media Ore/Turno': oreMedia.toFixed(2)
            };
        }
        
        // Calcola CV (MATEMATICA PURA)
        function calculateCV(values) {
            if (values.length === 0) return 0;
            
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            if (mean === 0) return 0;
            
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
            const stdDev = Math.sqrt(variance);
            
            return (stdDev / mean) * 100;
        }
        
        // Inizializza dashboard
        function initializeDashboard() {
            updateOverview();
            populateStaffSelects();
            updateCharts();
            updateCVTable();
            updateDetailTable();
        }
        
        // Aggiorna overview
        function updateOverview() {
            // Metriche generali
            const totalTurni = data.length;
            const totalOre = data.filter(r => r.ore_lavoro).reduce((sum, r) => sum + parseFloat(r.ore_lavoro), 0);
            const settimane = new Set(data.map(r => r.settimana)).size;
            const staffCount = staffList.length;
            
            document.getElementById('metricsGrid').innerHTML = `
                <div class="metric-card">
                    <h3>Turni Totali</h3>
                    <div class="value">${totalTurni}</div>
                </div>
                <div class="metric-card">
                    <h3>Ore Totali</h3>
                    <div class="value">${totalOre.toFixed(1)}h</div>
                </div>
                <div class="metric-card">
                    <h3>Settimane</h3>
                    <div class="value">${settimane}</div>
                </div>
                <div class="metric-card">
                    <h3>Staff</h3>
                    <div class="value">${staffCount}</div>
                </div>
            `;
            
            // Tabella staff
            let tableHTML = '<table><thead><tr><th>Staff</th><th>Turni</th><th>Ore Totali</th><th>Riposi</th><th>Ferie</th><th>Media h/turno</th></tr></thead><tbody>';
            
            staffList.forEach(staff => {
                const metrics = calcMetriche(staff);
                tableHTML += `
                    <tr>
                        <td><strong>${staff}</strong></td>
                        <td>${metrics['Turni Totali']}</td>
                        <td>${metrics['Ore Totali']}h</td>
                        <td>${metrics['Riposi']}</td>
                        <td>${metrics['Ferie']}</td>
                        <td>${metrics['Media Ore/Turno']}h</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            document.getElementById('staffTable').innerHTML = tableHTML;
        }
        
        // Popola select staff
        function populateStaffSelects() {
            const options1 = staffList.map((s, i) => `<option value="${s}" ${i === 0 ? 'selected' : ''}>${s}</option>`).join('');
            const options2 = staffList.map((s, i) => `<option value="${s}" ${i === 1 ? 'selected' : ''}>${s}</option>`).join('');
            
            document.getElementById('staff1Select').innerHTML = options1;
            document.getElementById('staff2Select').innerHTML = options2;
            document.getElementById('filterStaff').innerHTML = '<option value="">Tutti</option>' + options1;
            
            updateComparison();
        }
        
        // Aggiorna confronto
        function updateComparison() {
            const staff1 = document.getElementById('staff1Select').value;
            const staff2 = document.getElementById('staff2Select').value;
            
            if (!staff1 || !staff2 || staff1 === staff2) {
                document.getElementById('comparisonResult').innerHTML = 
                    '<div class="alert alert-info">‚ö†Ô∏è Seleziona due staff diversi per il confronto</div>';
                return;
            }
            
            const m1 = calcMetriche(staff1);
            const m2 = calcMetriche(staff2);
            
            let html = `
                <h3 style="margin: 20px 0;">üìä ${staff1} vs ${staff2}</h3>
                <div class="comparison-row header">
                    <div>Metrica</div>
                    <div>${staff1}</div>
                    <div>${staff2}</div>
                    <div>Diff</div>
                    <div>Diff %</div>
                    <div>Status</div>
                </div>
            `;
            
            const metriche = ['Ore Totali', 'Turni Normali', 'Riposi', 'Ferie'];
            
            metriche.forEach(metrica => {
                const val1 = parseFloat(m1[metrica]);
                const val2 = parseFloat(m2[metrica]);
                const diff = val1 - val2;
                const diffPerc = val2 !== 0 ? (diff / val2) * 100 : 0;
                
                let status, statusClass;
                if (Math.abs(diffPerc) < 10) {
                    status = '‚úÖ Equo';
                    statusClass = 'status-equo';
                } else if (Math.abs(diffPerc) < 20) {
                    status = '‚ö†Ô∏è Attenzione';
                    statusClass = 'status-warning';
                } else {
                    status = '‚ùå Squilibrato';
                    statusClass = 'status-danger';
                }
                
                html += `
                    <div class="comparison-row">
                        <div><strong>${metrica}</strong></div>
                        <div>${val1.toFixed(1)}</div>
                        <div>${val2.toFixed(1)}</div>
                        <div>${diff > 0 ? '+' : ''}${diff.toFixed(1)}</div>
                        <div>${diffPerc > 0 ? '+' : ''}${diffPerc.toFixed(2)}%</div>
                        <div><span class="status-badge ${statusClass}">${status}</span></div>
                    </div>
                `;
            });
            
            document.getElementById('comparisonResult').innerHTML = html;
        }
        
        // Aggiorna grafici
        function updateCharts() {
            // Grafico ore per staff
            const orePerStaff = {};
            staffList.forEach(staff => {
                const metrics = calcMetriche(staff);
                orePerStaff[staff] = parseFloat(metrics['Ore Totali']);
            });
            
            const ctx1 = document.getElementById('oreChart').getContext('2d');
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: Object.keys(orePerStaff),
                    datasets: [{
                        label: 'Ore Totali',
                        data: Object.values(orePerStaff),
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Ore Lavorate per Staff (Calcolo JavaScript)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Grafico turni
            const turniPerStaff = {};
            staffList.forEach(staff => {
                turniPerStaff[staff] = data.filter(r => r.staff === staff).length;
            });
            
            const ctx2 = document.getElementById('turniChart').getContext('2d');
            new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(turniPerStaff),
                    datasets: [{
                        data: Object.values(turniPerStaff),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', 
                            '#4BC0C0', '#9966FF', '#FF9F40'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribuzione Turni per Staff'
                        }
                    }
                }
            });
            
            // Grafico riposi
            const riposiPerStaff = {};
            staffList.forEach(staff => {
                const metrics = calcMetriche(staff);
                riposiPerStaff[staff] = parseInt(metrics['Riposi']);
            });
            
            const ctx3 = document.getElementById('riposiChart').getContext('2d');
            new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: Object.keys(riposiPerStaff),
                    datasets: [{
                        label: 'Riposi',
                        data: Object.values(riposiPerStaff),
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Giorni di Riposo per Staff'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Aggiorna tabella CV
        function updateCVTable() {
            const metriche = ['Ore Totali', 'Turni Totali', 'Riposi', 'Ferie'];
            
            let html = '<table><thead><tr><th>Metrica</th><th>Media</th><th>Std Dev</th><th>CV (%)</th><th>Status</th></tr></thead><tbody>';
            
            metriche.forEach(metrica => {
                let values = [];
                
                staffList.forEach(staff => {
                    const m = calcMetriche(staff);
                    values.push(parseFloat(m[metrica] || 0));
                });
                
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                const cv = calculateCV(values);
                const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
                const stdDev = Math.sqrt(variance);
                
                let status, statusClass;
                if (cv < 10) {
                    status = '‚úÖ OTTIMO';
                    statusClass = 'status-equo';
                } else if (cv < 20) {
                    status = '‚ö†Ô∏è ACCETTABILE';
                    statusClass = 'status-warning';
                } else {
                    status = '‚ùå SQUILIBRATO';
                    statusClass = 'status-danger';
                }
                
                html += `
                    <tr>
                        <td><strong>${metrica}</strong></td>
                        <td>${mean.toFixed(2)}</td>
                        <td>${stdDev.toFixed(2)}</td>
                        <td>${cv.toFixed(2)}%</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('cvTable').innerHTML = html;
        }
        
        // Aggiorna tabella dettaglio
        function updateDetailTable() {
            const filterStaff = document.getElementById('filterStaff').value;
            const filtered = filterStaff ? data.filter(r => r.staff === filterStaff) : data;
            
            let html = `
                <p>Mostrando <strong>${filtered.length}</strong> turni</p>
                <table>
                    <thead>
                        <tr>
                            <th>Staff</th>
                            <th>Settimana</th>
                            <th>Tipo Turno</th>
                            <th>Ore</th>
                            <th>Entrata</th>
                            <th>Uscita</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filtered.slice(0, 100).forEach(row => {
                html += `
                    <tr>
                        <td>${row.staff}</td>
                        <td>${row.settimana}</td>
                        <td>${row.tipo_turno}</td>
                        <td>${row.ore_lavoro || '-'}</td>
                        <td>${row.ora_entrata || '-'}</td>
                        <td>${row.ora_uscita || '-'}</td>
                    </tr>
                `;
            });
            
            if (filtered.length > 100) {
                html += `<tr><td colspan="6" style="text-align: center; color: #666;">
                    ... e altri ${filtered.length - 100} turni (scarica CSV per vedere tutti)
                </td></tr>`;
            }
            
            html += '</tbody></table>';
            document.getElementById('detailTable').innerHTML = html;
        }
        
        // Download CSV
        function downloadCSV() {
            const filterStaff = document.getElementById('filterStaff').value;
            const filtered = filterStaff ? data.filter(r => r.staff === filterStaff) : data;
            
            const csv = Papa.unparse(filtered);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `turni_${filterStaff || 'tutti'}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        // Mostra tab
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        // Inizializza al caricamento
        window.onload = loadData;
    </script>
</body>
</html>

